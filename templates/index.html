<!DOCTYPE html>
<html>
<head>
    <title>Risk Manager (Flask)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .container { display: flex; max-width: 1400px; margin: 20px auto; gap: 20px; font-family: sans-serif; }
        .panel { flex: 1; padding: 20px; border: 1px solid #333; background: #1e1e1e; color: #fff; border-radius: 8px; }
        .panel.left { max-width: 420px; }
        .header { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #00aaff; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .col { flex: 1; display: flex; flex-direction: column; }
        label { font-size: 0.8em; color: #ccc; margin-bottom: 3px; }
        input, select { padding: 8px; border: 1px solid #555; background: #2b2b2b; color: #fff; border-radius: 4px; }
        .button-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab { flex: 1; padding: 8px; border: none; background: #4a4a4a; color: #fff; border-radius: 4px; cursor: pointer; }
        .tab.active { background: #00aaff; }
        .status { padding: 12px; border: 2px solid #00aaff; background: #252525; border-radius: 6px; margin-bottom: 12px; font-size: 0.9em; line-height: 1.4; }
        .place { background: #00aaff; font-weight: bold; padding: 10px 14px; border-radius: 6px; cursor: pointer; color: #000; }
        .place:disabled { opacity: 0.5; cursor: not-allowed; }
        .reset { background: #ff6347; }
        .chart-box { min-height: 400px; background: #000; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; border: 1px solid #444; text-align: left; font-size: 0.85em; }
        th { background: #3a3a3a; color: #fff; }
        .long { color: #7aff00; font-weight: bold; }
        .short { color: #ff6347; font-weight: bold; }
        .message { padding: 10px; margin-bottom: 15px; border-radius: 4px; font-weight: bold; }
        .success { background-color: #7aff0022; border: 1px solid #7aff00; color: #7aff00; }
        .error { background-color: #ff634722; border: 1px solid #ff6347; color: #ff6347; }
        small { display: block; font-size: 0.75em; margin-top: 2px; color: #ccc; }
        .muted { color: #999; font-size: 0.85em; }
        .formula { background:#111; padding:8px; border-radius:6px; margin-top:8px; font-size:0.85em; color:#ddd; }
        .formula b { color:#ffcc00; }
    </style>
</head>

<body>

<div class="container">

    <div class="panel left">

        <div class="header">CORE CONTROLS</div>
        
        {% if trade_status %}
        <div class="message {{ 'success' if trade_status.success else 'error' }}">
            {{ trade_status.message }}
        </div>
        {% endif %}

        <form method="POST">
            <input type="hidden" name="capital_input" value="{{balance}}">
            <input type="hidden" name="side" value="{{default_side}}">

            <div class="row">
                <div class="col">
                    <label>Total Balance (USD$)</label>
                    <input type="number" name="balance_display" value="{{balance | round(2)}}" step="0.01" disabled>
                </div>
                <div class="col">
                    <label>Margin Used</label>
                    <input value="${{margin_used | round(2)}}" disabled>
                </div>
            </div>

            <div class="row" style="margin-bottom:6px;">
                <div class="col">
                    <label>Unutilised Capital</label>
                    {% set unutil = (balance - (margin_used or 0.0)) | round(2) %}
                    <input value="${{ unutil }}" disabled>
                    <small class="muted">Unutilised = Balance − Margin Used</small>
                </div>
                <div class="col">
                    <label>1% of Unutilised (Risk)</label>
                    {% set onepct = (unutil * 0.01) | round(2) %}
                    <input value="${{ onepct }}" disabled>
                    <small class="muted">This = 1% of unutilised capital — used to compute suggested lot</small>
                </div>
            </div>

            <div class="button-row" style="margin-bottom:6px;">
                {% for sym in symbols %}
                <button name="symbol" value="{{sym}}" class="tab {% if sym == selected_symbol %}active{% endif %}">{{sym}}</button>
                {% endfor %}
            </div>

            <div class="button-row" style="margin-bottom:10px;">
                <button name="side" value="LONG" class="tab {% if default_side == 'LONG' %}active{% endif %}">LONG</button>
                <button name="side" value="SHORT" class="tab {% if default_side == 'SHORT' %}active{% endif %}">SHORT</button>
            </div>

            <div class="row">
                <div class="col">
                    <label>Entry Price</label>
                    <input type="number" name="entry" step="0.00000001" value="{{default_entry}}">
                </div>

                <div class="col">
                    <label>SL Method</label>
                    <select name="sl_type" onchange="this.form.submit()">
                        <option value="SL Points" {% if default_sl_type == 'SL Points' %}selected{% endif %}>SL Points</option>
                        <option value="SL % Movement" {% if default_sl_type == 'SL % Movement' %}selected{% endif %}>SL % Movement</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>SL Value ({{ 'Points' if default_sl_type == 'SL Points' else '% Movement' }})</label>
                    <input type="number" step="0.01" name="sl_value" value="{{default_sl_value}}" min="0">
                    <small class="muted">SL is mandatory — you cannot place a trade without SL.</small>
                </div>
                
                <div class="col">
                    <label>Max Leverage</label>
                    <input value="{{ sizing.max_leverage_info or 'N/A' }}" disabled style="color: #ffcc00; font-weight: bold;">
                    {% if default_sl_type == 'SL % Movement' %}
                        <small style="color: #ffcc00;">* Based on SL% (100 / SL%)</small>
                    {% else %}
                        <small>&nbsp;</small> {% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>TP 1 Price</label>
                    <input type="number" name="tp1_price" step="0.00000001" value="{{ request.form.tp1_price or 0.0 }}">
                </div>

                <div class="col">
                    <label>TP 1 % Position</label>
                    <input type="number" name="tp1_percent" step="0.1" value="{{ request.form.tp1_percent or 0.0 }}">
                </div>
            </div>

            <div class="col" style="margin-bottom:10px;">
                <label>TP 2 Price (Full Exit)</label>
                <input type="number" name="tp2_price" step="0.00000001" value="{{ request.form.tp2_price or 0.0 }}">
            </div>

            <div class="row">
                <div class="col">
                    <label>Position/Lot Size (Override)</label>
                    <input type="number" name="user_units" step="0.00000001" value="{{default_units}}">
                    <small style="color:#7aff00;">Suggested: {{sizing.suggested_units | round(4) | default('0.0000')}}</small>
                </div>

                <div class="col">
                    <label>Leverage (Override)</label>
                    <input type="number" name="user_lev" step="0.01" value="{{default_lev}}">
                    <small style="color:#7aff00;">Suggested: {{sizing.suggested_leverage | round(1) | default('0.0')}}x</small>
                </div>
            </div>

            <div class="status">
                {% set suggested_units = (sizing.suggested_units or 0.0) | round(4) %}
                {% set suggested_lev = (sizing.suggested_leverage or 0.0) | round(2) %}
                {% set risk_amount = (sizing.risk_amount or onepct or 0.0) | round(2) %}
                
                {% set total_trades = stats.total | default(0) %}
                {% set symbol_trades = stats.by_symbol.get(selected_symbol, 0) %}

                {% if sizing.error %}
                    <span style="color: #ff6347; font-weight: bold;">RISK ERROR:</span> {{ sizing.error }}
                    <div class="formula">
                        <b>Why blocked:</b> SL must be set and sizing must be valid to place an order.
                    </div>
                {% else %}
                    <span style="color: #7aff00; font-weight: bold;">READY:</span> Units/Lot: {{ suggested_units }} | Leverage: {{ suggested_lev }}x | Max Risk: <span style="font-weight: bold;">${{ risk_amount }}</span>
                    <div class="formula">
                        <div><b>Formulas used</b> (visible for transparency):</div>
                        {% if default_sl_type == 'SL Points' %}
                            <div>• <b>Risk</b> = 1% of Unutilised = ${{ onepct }}</div>
                            <div>• <b>SL distance</b> = SL Points + 20</div>
                            <div>• <b>Suggested Lot</b> = Risk ÷ (SL Points + 20) = <b>{{ suggested_units }}</b></div>
                        {% else %}
                            <div>• <b>Risk</b> = 1% of Unutilised = ${{ onepct }}</div>
                            <div>• <b>SL distance</b> = SL% + 0.2%</div>
                            <div>• <b>Suggested Lot</b> = Risk ÷ (SL% + 0.2) = <b>{{ suggested_units }}</b></div>
                            <div>• <b>Max Leverage</b> = 100 ÷ SL% = <b>{{ sizing.max_leverage_info or ( (100.0 / (default_sl_value|float)) ~ 'x' ) }}</b></div>
                        {% endif %}
                        <div style="margin-top:6px; color:#ccc;">Overrides are allowed (lot & leverage) but cannot exceed suggested values.</div>
                    </div>
                {% endif %}

                <br>Daily Trades: <span style="font-weight: bold;">{{total_trades}}/{{daily_max_trades}}</span> | {{selected_symbol}} Trades: <span style="font-weight: bold;">{{symbol_trades}}/{{daily_max_per_symbol}}</span>
            </div>

            <div style="display:flex; gap:8px; margin-top:10px;">
                <button type="submit" class="place" name="place_order"
                    {% if sizing.error or total_trades >= daily_max_trades or symbol_trades >= daily_max_per_symbol %} disabled {% endif %}
                >PLACE ORDER</button>

                <button type="submit" name="reset" class="reset" style="padding:10px;border-radius:6px;">RESET</button>
            </div>

        </form>
    </div>


    <div class="panel right">

        <div class="header">CHART VIEW ({{selected_symbol}})</div>
        <div class="chart-box">
            {{ chart_html | safe }}
        </div>

        <div class="header">TODAY'S TRADE LOG</div>

        {% set today_iso = today.date().isoformat() %}
        
        {% set today_trades = trades | selectattr('date', 'equalto', today_iso) | list %}
        
        {% if today_trades %}
        <table>
            <tr>
                <th>Time</th><th>Symbol</th><th>Side</th><th>Entry</th><th>SL Value</th><th>Units</th><th>Leverage</th><th>Risk ($)</th>
            </tr>

            {% for t in today_trades | reverse %}
            <tr>
                <td>{{ datetime.fromisoformat(t.timestamp).strftime('%H:%M:%S') }}</td>
                <td>{{t.symbol}}</td>
                <td class="{% if t.side=='LONG' %}long{% else %}short{% endif %}">
                    {{t.side}}
                </td>
                <td>{{t.entry_price | round(4)}}</td>
                <td>
                    {{ t.stop_loss | round(2) }} 
                    {% if t.sl_mode == 'SL % Movement' %}
                        %
                    {% else %}
                        Pts
                    {% endif %}
                </td>
                <td>{{t.units | round(4)}}</td>
                <td>{{t.leverage | round(1)}}x</td>
                <td>${{t.risk_usd | round(2)}}</td>
            </tr>
            {% endfor %}
        </table>

        {% else %}
        <p class="no-trades" style="color:#ccc;">No trades today.</p>
        {% endif %}

    </div>

</div>
<script>const datetime = { fromisoformat: (s) => new Date(s) };</script>
</body>
</html>
